# Сети в Linux

Настройка сетей в Linux на виртуальных машинах.

## Part 1. Инструмент **ipcalc**

__Поднимем виртуальную машину ws1__

![ws1](screen/part0.PNG) <br>*виртуальная машина ws1*<br>

Проверим версию системы

![ws1](screen/part1.1.PNG) <br>*версия машины ws1*<br>

Установим **ipcalc**

![ipcalc](screen/part1.1_1.PNG) <br>*команда установки ipcalc*<br>

#### 1.1. Сети и маски

1) __адрес сети *192.167.38.54/13*__

    ![ipcalc](screen/part1.1_2.PNG) <br>*адрес сети 192.167.38.54/13*<br>

2) __перевод маски _255.255.255.0_ в префиксную и двоичную запись, _/15_ в обычную и двоичную, _11111111.11111111.11111111.11110000_ в обычную и префиксную__
    
    - перевод маски _255.255.255.0_  в префиксную и двоичную запись
        ![ipcalc](screen/part1.1_3.PNG) <br>*в префиксную и двоичную запись*<br>
    
        Префиксная запись - _/24_<br>
        Двоичная запись - _11111111.11111111.11111111. 000000000_
    
    - перевод _/15_ в обычную и двоичную
        ![ipcalc](screen/part1.1_4.PNG) <br>*в обычную и двоичную запись*<br>
    
        Обычная запись - _255.254.0.0_<br>
        Двоичная запись - _11111111.11111110.00000000.000000000_
    
    - перевод _11111111.11111111.11111111.11110000_ в обычную и префиксную запись
    
        Для перевода в префиксную запись необходимо посчитать количество ненулевых бит - 28.
    
        Проверим:
    
        ![ipcalc](screen/part1.1_5.PNG) <br>*/28 в обычную и двоичную запись*<br>

        Обычная запись - _255.255.255.240_<br>
        Префиксная запись - _/28_
    
3) __минимальный и максимальный хост в сети _12.167.38.4_ при масках: _/8_, _11111111.11111111.00000000.00000000_, _255.255.254.0_ и _/4___

    - при маске _/8_
    
        ![ipcalc](screen/part1.1_6.PNG) <br>*мин. и макс. хост при маске /8*<br>
    
    - при маске _11111111.11111111.00000000.00000000_
        Для начала переведем _11111111.11111111.00000000.00000000_ в префиксную запись - _/16_
    
        ![ipcalc](screen/part1.1_7.PNG) <br>*мин. и макс. хост при маске /16*<br>
    
    - при маске _255.255.254.0_
    
        ![ipcalc](screen/part1.1_8.PNG) <br>*мин. и макс. хост при маске 255.255.254.0*<br>
    
    - при маске _/4_
    
        ![ipcalc](screen/part1.1_9.PNG) <br>*мин. и макс. хост при маске /4*<br>
    
#### 1.2. localhost
    
**Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: _194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1_**

К приложению, работающему на localhost, можно обратиться, если в _Hosts/Net_ есть _Loopback_.

Нельзя обратиться:

- ![ipcalc](screen/part1.1_10.PNG) <br>*194.34.23.100*<br>

- ![ipcalc](screen/part1.1_13.PNG) <br>*128.0.0.1*<br>

Можно обратиться:

- ![ipcalc](screen/part1.1_11.PNG) <br>*127.0.0.2*<br>

- ![ipcalc](screen/part1.1_12.PNG) <br>*127.1.0.1*<br>

#### 1.3. Диапазоны и сегменты сетей

1) __какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: _10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1___

IP можно использовать в качестве частных, если в _Hosts/Net_ есть _Private Internet_.

К публичным относятся:

- ![ipcalc](screen/part1.1_15.PNG) <br>*134.43.0.2*<br>

- ![ipcalc](screen/part1.1_18.PNG) <br>*172.0.2.1*<br>

- ![ipcalc](screen/part1.1_19.PNG) <br>*192.172.0.1*<br>

- ![ipcalc](screen/part1.1_20.PNG) <br>*172.68.0.2*<br>

- ![ipcalc](screen/part1.1_23.PNG) <br>*192.169.168.1*<br>

К частным относятся:

- ![ipcalc](screen/part1.1_14.PNG) <br>*10.0.0.45*<br>

- ![ipcalc](screen/part1.1_16.PNG) <br>*192.168.4.2*<br>

- ![ipcalc](screen/part1.1_17.PNG) <br>*172.20.250.4*<br>

- ![ipcalc](screen/part1.1_21.PNG) <br>*172.16.255.255*<br>

- ![ipcalc](screen/part1.1_22.PNG) <br>*10.10.10.10*<br>

2) __какие из перечисленных IP адресов шлюза возможны у сети _10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255___

Смотрим на минимальный и максимальный хост у сети _10.10.0.0/18_.  
Флаг _-b_ позволяет убрать двоичный вывод.

![ipcalc](screen/part1.1_24.PNG) <br>*10.10.0.0/18*<br>

Соотвественно, у сети _10.10.0.0/18_ возможны следующие IP адреса: _10.10.0.2, 10.10.10.10, 10.10.1.255_.
    
## Part 2. Статическая маршрутизация между двумя машинами

__Поднимаем две виртуальные машины -- ws1 и ws2__

![ipcalc](screen/part2_1.PNG) <br>ws1 и ws2<br>

Для удобства сменим _hostname_ у  _ws1_ на _ws1_:

![ipcalc](screen/part2_1.0.PNG) <br>команда для смены _hostname_ и дальнейшего редактирования<br>

__С помощью команды `ip a` посмотрим существующие сетевые интерфейсы__

![ipcalc](screen/part2_2.PNG) <br>`ip a` на ws1<br>

![ipcalc](screen/part2_3.0.PNG) <br>`ip a` на ws2<br>

__Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - _192.168.100.10_, маска _/16_, ws2 - _172.24.116.8_, маска /_12___

Включаем внутреннюю сеть для маршрутизации между двумя машинами:

![ipcalc](screen/part2_3.1.PNG) <br>внутренняя сеть на ws1 и ws2<br>

1. Описание сетевего интерфейса на ws1 - _192.168.100.10_, маска _/16_:

    Открываем файл `etc/netplan/00-installer-config.yaml`  для редактирования

    ![ipcalc](screen/part2_4.PNG) <br>_команда открытия 00-installer-config.yaml_ на ws1<br>

    ![ipcalc](screen/part2_5.PNG) <br>_00-installer-config.yaml_ на ws1<br>

    Редактируем этот файл:

    ![ipcalc](screen/part2_6.PNG) <br>_измененный 00-installer-config.yaml_ на ws1<br>

    Применяем команду `sudo netplan apply` для перезапуска сервиса сети.
    
    ![ipcalc](screen/part2_9.PNG) <br>`netplan apply` на ws1<br>
    
2. Описание сетевего интерфейса на ws2 - _172.24.116.8_, маска /_12_:

    Открываем файл `etc/netplan/00-installer-config.yaml`  для редактирования

    ![ipcalc](screen/part2_7.PNG) <br>_команда открытия 00-installer-config.yaml_ на ws2<br>

    ![ipcalc](screen/part2_8.PNG) <br>_измененный 00-installer-config.yaml_ на ws2<br>

    Применяем команду `sudo netplan apply` для перезапуска сервиса сети.
    
    ![ipcalc](screen/part2_10.PNG) <br>`netplan apply` на ws2<br>

Посмотрим существующие сетевые интерфейсы:

![ipcalc](screen/part2_11.PNG) <br>`ip a` после изменений на ws1<br>

![ipcalc](screen/part2_12.PNG) <br>`ip a` после изменений на ws2<br>

#### 2.1. Добавление статического маршрута вручную

__Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add__

![ipcalc](screen/part2_14.PNG) <br>Добавление статического маршрута на ws1<br>

![ipcalc](screen/part2_15.PNG) <br>Добавление статического маршрута на ws2<br>

__Пропинговать соединение между машинами__

![ipcalc](screen/part2_16.PNG) <br>Пинг с ws1 на ws2<br>

![ipcalc](screen/part2_17.PNG) <br>Пинг с ws2 на ws1<br>
    
####  2.2. Добавление статического маршрута с сохранением

__Перезапустить машины__

Команда на обеих машинах - `sudo reboot`

После перезапуска таблица маршрутизации сбрасывается на обеих машинах.

__Добавить статический маршрут от одной машины до другой с помощью файла _etc/netplan/00-installer-config.yaml___

Редактируем _etc/netplan/00-installer-config.yaml_ на обеих машинах:

![ipcalc](screen/part2_19.PNG) <br>_измененный 00-installer-config.yaml_ на ws1<br>

![ipcalc](screen/part2_20.PNG) <br>_измененный 00-installer-config.yaml_ на ws2<br>

Выполнить команду `netplan apply` для перезапуска сервиса сети и __пропингуем соединение между машинами__:

![ipcalc](screen/part2_22.PNG) <br>пинг с ws1 на ws2<br>

![ipcalc](screen/part2_23.PNG) <br>пинг с ws2 на ws1<br>

## Part 3. Утилита __iperf3__

#### 3.1. Скорость соединения

__Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps__

- 8 Mbps (мегабит в секуду) = 1 MB/s (мегабайт в секунду)
- 100 MB/s (мегабайт в секунду) = 800 000 Kbps (килобит в секунду)
- 1 Gbps (гигабит в секунду) = 1 000 Mbps (мегабит в секунду)

#### 3.2. Утилита __iperf3__

Устанавливаем утилиту __iperf3__ на ws1 и ws2 командой - `sudo apt install iperf3`

![ipcalc](screen/part3_1.PNG) <br>Установка утилиты __iperf3__ на ws1<br>

На ws1 запускаем __iperf3__ в режиме сервера: `iperf3 -s`

![ipcalc](screen/part3_2.PNG) <br>запуск __iperf3__ на ws1<br>

На клиенте ws2 запускаем __iperf3__ с указанием IP сервера к которому подключаемся: 

![ipcalc](screen/part3_3.PNG) <br>запуск __iperf3__ на ws2 для тестирования<br>

Вывод на ws1:

![ipcalc](screen/part3_4.PNG) <br>измерение скорости на ws1<br>

## Part 4. Сетевой экран

#### 4.1. Утилита iptables

__Создать файл _/etc/firewall.sh_, имитирующий фаерволл, на ws1 и ws2:__

Создаем файл и открываем его для редактирования:

![ipcalc](screen/part4_1.PNG) <br>команда создания файла _/etc/firewall.sh_<br>

__Нужно добавить в файл подряд следующие правила:__

1) __на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)__

2)  __на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)__

3) __открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)__

4) __запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)__

5) __разрешить echo reply (машина должна "пинговаться")__

![ipcalc](screen/part4_2.PNG) <br>файл _/etc/firewall.sh_ на ws1<br>

![ipcalc](screen/part4_3.PNG) <br>файл _/etc/firewall.sh_ на ws2<br>

__Запускаем файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`__

![ipcalc](screen/part4_4.PNG) <br>Запускаем файл на ws1<br>

![ipcalc](screen/part4_5.PNG) <br>Запускаем файл на ws2<br>

Разница между стратегиями, применёнными в первом и втором файлах:
В утилите iptables правила выполняются сверху вниз. 
На ws1 первым указано запрещающее правило на выход, поэтому она не сможет пропинговать другую машину. 
У ws2 первым указано разрешающее правило, значит она сможет пропинговать другую машину.

![ipcalc](screen/part4_6.PNG) <br>Пингуем с ws1 на ws2<br>

![ipcalc](screen/part4_7.PNG) <br>Пингуем с ws2 на ws1<br>

#### 4.2. Утилита __nmap__

__Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен:__

![ipcalc](screen/part4_6.PNG) <br>Пингуем с ws1 на ws2<br>

![ipcalc](screen/part4_7.PNG) <br>Пингуем с ws2 на ws1<br>

ws1 не пингуется, покажем, что хост машины запущен: 

![ipcalc](screen/part4_9.PNG) <br>запуск __nmap__ на ws2 для проверки ws1<br>

_Проверка_: в выводе nmap должно быть сказано: `Host is up`

Сохранить дампы образов виртуальных машин:

![ipcalc](screen/part4_10.PNG) <br>Сохранение дампов образов <br>

## Part 5. Статическая маршрутизация сети

Сеть: 

![ipcalc](screen/part4_8.PNG) <br>

__Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))__

![ipcalc](screen/part5_1.PNG) <br>пять виртуальных машин<br>

#### 5.1. Настройка адресов машин

Добавляем адаптеры для ws11, ws21, w22

![ipcalc](screen/part5_1.0.PNG) <br>адаптер для ws11<br>

![ipcalc](screen/part5_1.1.PNG) <br>адаптер для ws21 и ws22<br>

Добавляем адаптеры для r1, r2

![ipcalc](screen/part5_1.2.PNG) <br>адаптер 2 для r1<br>

![ipcalc](screen/part5_1.3.PNG) <br>адаптер 3 для r1<br>

![ipcalc](screen/part5_1.4.PNG) <br>адаптер 2 для r2<br>

![ipcalc](screen/part5_1.5.PNG) <br>адаптер 3 для r2<br>

__Настроить конфигурации машин в _etc/netplan/00-installer-config.yaml_ согласно сети на рисунке.__

Редактируем файл _etc/netplan/00-installer-config.yaml_ для каждой машины:

![ipcalc](screen/part5_2.PNG) <br>00-installer-config.yaml ws11<br>

![ipcalc](screen/part5_3.PNG) <br>00-installer-config.yaml ws21<br>

![ipcalc](screen/part5_4.PNG) <br>00-installer-config.yaml ws22<br>

![ipcalc](screen/part5_5.PNG) <br>00-installer-config.yaml r1<br>

![ipcalc](screen/part5_6.PNG) <br>00-installer-config.yaml r2<br>

__Перезапускаем сервисы сети командой__ - `sudo netplan apply`

Командой `ip -4 a` проверим, что адрес машин задан верно.

![ipcalc](screen/part5_7.PNG) <br>адрес ws11<br>

![ipcalc](screen/part5_8.PNG) <br>адрес ws21<br>

![ipcalc](screen/part5_9.PNG) <br>адрес ws22<br>

![ipcalc](screen/part5_10.PNG) <br>адрес r1<br>

![ipcalc](screen/part5_11.PNG) <br>адрес r2<br>

Пропингуем ws22 с ws21

![ipcalc](screen/part5_12.PNG) <br>пинг ws22 с ws21<br>

Пропингуем r1 с ws11

![ipcalc](screen/part5_13.PNG) <br>пинг r1 с ws11<br>

#### 5.2. Включение переадресации IP-адресов.

__Для включения переадресации IP, выполним команду на роутерах:__
`sysctl -w net.ipv4.ip_forward=1`. _При таком подходе переадресация не будет работать после перезагрузки системы._

![ipcalc](screen/part5_14.PNG) <br>включения переадресации на r1<br>

![ipcalc](screen/part5_15.PNG) <br>включения переадресации на r2<br>

Откроем файл _/etc/sysctl.conf_ на каждом роутере и добавим в него следующую строку:
`net.ipv4.ip_forward = 1`. _При использовании этого подхода, IP-переадресация включена на постоянной основе._

![ipcalc](screen/part5_16.PNG) <br>файл _/etc/sysctl.conf_  на r1 и r2<br>

![ipcalc](screen/part5_17.PNG) <br>редактирование _/etc/sysctl.conf_  на r1 и r2<br>

#### 5.3. Установка маршрута по-умолчанию

__Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций__

![ipcalc](screen/part5_18.PNG) <br>маршрут по-умолчанию (шлюз) для ws11<br>

![ipcalc](screen/part5_19.PNG) <br>маршрут по-умолчанию (шлюз) для ws21<br>

![ipcalc](screen/part5_20.PNG) <br>маршрут по-умолчанию (шлюз) для ws22<br>

__Вызваем `ip r` и покажем, что добавился маршрут в таблицу маршрутизации__

![ipcalc](screen/part5_21.PNG) <br> `ip r` для ws11<br>

![ipcalc](screen/part5_22.PNG) <br> `ip r`  для ws21<br>

![ipcalc](screen/part5_23.PNG) <br> `ip r`  для ws22<br>

__Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`__

![ipcalc](screen/part5_24.PNG) <br> пинг r2  с ws11<br>

Пинг не проходит, потому что r2 не может вернуть ответ, но при этом передача пакетов с ws11 есть.
Запускаем на r2 утилиту __tcpdump__, чтобы прослушать и вывести информацию с каких IP адресов приходят пакеты.

![ipcalc](screen/part5_25.PNG) <br> tcpdump на r2<br>

#### 5.4. Добавление статических маршрутов
___Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.__

![ipcalc](screen/part5_26.PNG) <br>статический маршрут на r1<br>

![ipcalc](screen/part5_27.PNG) <br>статический маршрут на r2<br>

Перезапустим сервисы сети командой - `sudo netplan apply`

__Вызвем `ip r` и покажем таблицы с маршрутами на обоих роутерах. 
![ipcalc](screen/part5_28.PNG) <br>статический маршрут на r1<br>

![ipcalc](screen/part5_29.PNG) <br>статический маршрут на r2<br>

__Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`__

![ipcalc](screen/part5_30.PNG) <br>запуск команд на r1<br>

Для адреса _10.10.0.0/18_ был выбран маршрут, отличный от 0.0.0.0/0 (он попадает под маршрут по-умолчанию). IP-адрес 0.0.0.0/0 действует как резервный, пока не будет назначен действительный маршрутизируемый IP-адрес. Машина ws11 соединена с сетью 10.10.0.0/18 по своему IP-адресу 10.10.0.2, для других адресов используется маршрут по умолчанию - 10.10.0.1.

#### 5.5. Построение списка маршрутизаторов

Установим утилиту __traceroute__

![ipcalc](screen/part5_31.PNG) <br>установка  __traceroute__ на ws11<br>

__Запустим на r1 команду дампа:__

![ipcalc](screen/part5_32.PNG) <br>запуск команды дампа на r1<br>

![ipcalc](screen/part5_33.PNG) <br>запуск команды дампа на r1<br>

__При помощи утилиты traceroute строим список маршрутизаторов на пути от ws11 до ws21__

![ipcalc](screen/part5_34.PNG) <br>строим список маршрутизаторов от ws11 до ws21<br>

Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

#### 5.6. Использование протокола ICMP при маршрутизации

__Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:__
`tcpdump -n -i eth0 icmp`

![ipcalc](screen/part5_36.PNG) <br>Запуск на r1 перехвата сетевого трафика<br>

__Пропингуем с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:__
`ping -c 1 10.30.0.111`

![ipcalc](screen/part5_35.PNG) <br>Запуск на r1 перехвата сетевого трафика<br>

__Сохранить дампы образов виртуальных машин__

![ipcalc](screen/part5_37.PNG) <br>Сохранение дампов образов<br>

## Part 6. Динамическая настройка IP с помощью DHCP

Установим DHCP сервер на r2 и r1

![ipcalc](screen/part6_1.PNG) <br>Установка DHCP сервера<br>

__Для r2 настроить в файле _/etc/dhcp/dhcpd.conf_ конфигурацию службы DHCP:__

Откроем файл для редактирования:

![ipcalc](screen/part6_2.PNG) <br>команда для редактирования _/etc/dhcp/dhcpd.conf_<br>

![ipcalc](screen/part6_3.PNG) <br>файл _/etc/dhcp/dhcpd.conf_<br>

1) __указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.__

![ipcalc](screen/part6_4.PNG) <br>измененный файл _/etc/dhcp/dhcpd.conf_<br>

2) __в файле _resolv.conf_ прописать nameserver `8.8.8.8`.__

Откроем файл для редактирования:

![ipcalc](screen/part6_5.PNG) <br>команда для редактирования _resolv.conf_<br>

![ipcalc](screen/part6_6.PNG) <br>файл  _resolv.conf_<br>

![ipcalc](screen/part6_7.PNG) <br>измененный файл  _resolv.conf_<br>

__Перезагружаем службу DHCP командой `systemctl restart isc-dhcp-server`.__

![ipcalc](screen/part6_8.PNG) <br>Перезагрузка службы DHCP<br>

![ipcalc](screen/part6_8_1.PNG) <br>Статус службы DHCP<br>

Изменим настройки в файле  _etc/netplan/00-installer-config.yaml_ для ws21, чтобы сделать протокол DHCP активным. 

![ipcalc](screen/part6_10.PNG) <br>_etc/netplan/00-installer-config.yaml_ для ws21<br>

После чего применим команду для перезагрузки сервисов сети - `sudo netplan apply`

__Машину ws21 перезагружаем при помощи `reboot`__

__Через `ip a` показать, что она получила адрес__

![ipcalc](screen/part6_10.PNG) <br>`ip a`  на ws21<br>

__Пингуем ws22 с ws21.__

![ipcalc](screen/part6_12.PNG) <br>Пинг ws22 с ws21<br>

__Указать MAC адрес у ws11, для этого в _etc/netplan/00-installer-config.yaml_ надо добавить строки: macaddress: `10:10:10:10:10:BA`, `dhcp4: true`__

Снова редактируем файл _etc/netplan/00-installer-config.yaml_ для ws11:

![ipcalc](screen/part6_13.PNG) <br>файл _etc/netplan/00-installer-config.yaml_ для ws11<br>

После применяем команду - `sudo netplan aplly`

Так же добавляем MAC-адресс в адаптер 2:

![ipcalc](screen/part6_14.PNG) <br>MAC-адресс в адаптер 2 для ws11<br>

__Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты__

Откроем файл  _/etc/dhcp/dhcpd.conf_  для редактирования :

![ipcalc](screen/part6_15.PNG) <br>команда для редактирования _/etc/dhcp/dhcpd.conf_<br>

![ipcalc](screen/part6_16.PNG) <br>измененный файл _/etc/dhcp/dhcpd.conf_<br>

Откроем файл _resolv.conf_ для редактирования:

![ipcalc](screen/part6_17.PNG) <br>команда для редактирования _resolv.conf_<br>

![ipcalc](screen/part6_18.PNG) <br>измененный файл  _resolv.conf_<br>

__Перезагружаем службу DHCP командой `systemctl restart isc-dhcp-server`.__

![ipcalc](screen/part6_19.PNG) <br>Перезагрузка службы DHCP<br>

![ipcalc](screen/part6_20.PNG) <br>Статус службы DHCP<br>

__Машину ws11 перезагружаем при помощи `reboot`__

__Через `ip a` показать, что она получила адрес__

![ipcalc](screen/part6_21.PNG) <br>`ip a`  на ws11<br>

__Пингуем ws22 с ws21.__

![ipcalc](screen/part6_22.PNG) <br>Пинг ws22 с ws11<br>

__Запросить с ws21 обновление ip адреса__

Проверяем IP до обновления

![ipcalc](screen/part6_23.PNG) <br>IP адреса ws21 до обновления<br>

Запросим с ws21 обновление IP-адреса с помощью команды `sudo dhclient -v`

![ipcalc](screen/part6_24.PNG) <br>обновление IP-адреса ws21<br>

![ipcalc](screen/part6_24_1.PNG) <br>удаление старого IP-адреса ws21<br>

__Через `ip a` посмотрим, адреса после обновления__ 
![ipcalc](screen/part6_25.PNG) <br>удаление старого IP-адреса ws21<br>

Были использованы такие опции DHCP сервера:
- option routers ip-address [, ip-address...]; - адреса шлюзов для клиентской сети. 
- option domain-name-servers ip-address [, ip-address...]; - Список DNS серверов доступных клиенту.

__Сохранить дампы образов виртуальных машин__

![ipcalc](screen/part6_26.PNG) <br>сохранение дампов машин<br>

## Part 7. NAT

Установим сервер apache2 на r1, r2 и ws22.

![ipcalc](screen/part7_1.PNG) <br>Установка сервера apache2<br>

__В файле _/etc/apache2/ports.conf_ на ws22 и r1 изменить строку `Listen 80` на `Listen 0.0.0.0:80`, то есть сделать сервер Apache2 общедоступным__

Редактируем файл _/etc/apache2/ports.conf_ на ws22 и r1

![ipcalc](screen/part7_2.PNG) <br>Редактируем файл _/etc/apache2/ports.conf_<br>

![ipcalc](screen/part7_3.PNG) <br>измененный файл _/etc/apache2/ports.conf_ на ws22<br>

![ipcalc](screen/part7_4.PNG) <br>измененный файл _/etc/apache2/ports.conf_ на r1<br>

__Запустить веб-сервер Apache командой `service apache2 start` на ws22 и r1__

![ipcalc](screen/part7_5.PNG) <br>Запускаем веб-сервер Apache на ws22<br>

![ipcalc](screen/part7_6.PNG) <br>Запускаем веб-сервер Apache на r1<br>

__Добавить в фаерволл, созданный по аналогии с фаерволлом из Части 4, на r2 следующие правила:__

1) __удаление правил в таблице filter - `iptables -F`__


2) __удаление правил в таблице "NAT" - `iptables -F -t nat`__


3) __отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`__

Создаем фаерволл и редактируем его на r2:

![ipcalc](screen/part7_7.PNG) <br>Создаем фаерволл на r2<br>

![ipcalc](screen/part7_8.PNG) <br>Добавляем в фаерволл правила<br>

__Запускать файл также, как в Части 4__

![ipcalc](screen/part7_9.PNG) <br>_Запускать файл _firewall.sh_<br>

__Проверить соединение между ws22 и r1 командой `ping`__

![ipcalc](screen/part7_10.PNG) <br>Пингуем ws22 с r1 <br>

_При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1_

__Добавить в файл ещё одно правило:__

4) __разрешить маршрутизацию всех пакетов протокола ICMP__

![ipcalc](screen/part7_11.PNG) <br>Добавляем 4 правило<br>

__Запускать файл также, как в Части 4__

![ipcalc](screen/part7_12.PNG) <br>_Запускать файл _firewall.sh_<br>

__Проверить соединение между ws22 и r1 командой `ping`__

![ipcalc](screen/part7_13.PNG) <br>Пингуем ws22 с r1 <br>

_При запуске файла с этими правилами, ws22 должна "пинговаться" с r1_

__Добавить в файл ещё два правила:__

5) __включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)__
_Совет: стоит подумать о маршрутизации внутренних пакетов, а также внешних пакетов с установленным соединением_

6) __включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети__
_Совет: стоит учесть, что при попытке подключения возникнет новое tcp-соединение, предназначенное ws22 и 80 порту_

![ipcalc](screen/part7_14.PNG) <br>Добавляем правила 5 и 6<br>

_Перед тестированием рекомендуется отключить сетевой интерфейс NAT (его наличие можно проверить командой ip a) в VirtualBox, если он включен_

Отключим сетевой интерфейс NAT и проверим:

![ipcalc](screen/part7_16.PNG) <br>проверяем отсутствие сетевого интерфейса NAT<br>

__Запускать файл также, как в Части 4__

![ipcalc](screen/part7_15.PNG) <br>_Запускать файл _firewall.sh_<br>

__Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой:__
`telnet [адрес] [порт]`

Проверить подмену IP-адреса можно с помощью команды tcpdump - пингуем с машины ws22 роутер r1

![ipcalc](screen/part7_18_1.PNG) <br>Проверим подмену IP-адреса<br>

![ipcalc](screen/part7_18.PNG) <br>Проверим соединение по TCP для SNAT<br>

__Проверить соединение по TCP для DNAT, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` (обращаться по адресу r2 и порту 8080)__

![ipcalc](screen/part7_19.PNG) <br>Проверим соединение по TCP для DNAT<br>

__Сохранить дампы образов виртуальных машин__

![ipcalc](screen/part7_20.PNG) <br>Сохранение дампов образов<br>

## Part 8. Дополнительно. Знакомство с SSH Tunnels

__Запустить на r2 фаервол с правилами из Части 7__

![ipcalc](screen/part8_1.PNG) <br>фаервол на r2<br>

__Запускать файл также, как в Части 4__

![ipcalc](screen/part8_2.PNG) <br>_Запускать файл _firewall.sh_<br>

По умолчанию SSH не позволяет переадресовать удаленную часть порта. Необходимо это включить.

Редактируем файл конфигурации:

![ipcalc](screen/part8_20.PNG) <br>Редактируем файл конфигурации<br>

![ipcalc](screen/part8_21.PNG) <br>Файл конфигурации<br>

![ipcalc](screen/part8_30.PNG) <br>Измененный файл конфигурации<br>

Перезагрузим sshd:

![ipcalc](screen/part8_23.PNG) <br>Перезагрузка sshd<br>

__Запустить веб-сервер Apache на ws22 только на localhost (то есть в файле _/etc/apache2/ports.conf_ изменить строку `Listen 80` на `Listen localhost:80`)__

![ipcalc](screen/part8_3.PNG) <br>файл _/etc/apache2/ports.conf_ на ws22<br>

![ipcalc](screen/part8_4.PNG) <br>Запуск веб-сервера Apache на ws22 <br>

![ipcalc](screen/part8_5.PNG) <br>Проверка состояния веб-сервера Apache на ws22 <br>

__Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21__

![ipcalc](screen/part8_6.PNG) <br>Local TCP forwarding с ws21 до ws22 <br>

![ipcalc](screen/part8_7.PNG) <br>вывод ws22 с ws21 <br>

__Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:__
`telnet 127.0.0.1 [локальный порт]`

Проверка со второго терминала (клавишами Alt + F2):

![ipcalc](screen/part8_8.PNG) <br>Проверка подключения<br>

__Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11__

![ipcalc](screen/part8_9.PNG) <br>Remote TCP forwarding c ws11 до ws22<br>

![ipcalc](screen/part8_10.PNG) <br>вывод ws22 с ws11 <br>

__Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду:__
`telnet 127.0.0.1 [локальный порт]`

Проверка со второго терминала (клавишами Alt + F2):

![ipcalc](screen/part8_11.PNG) <br>Проверка подключения<br>

__Сохранить дампы образов виртуальных машин__

![ipcalc](screen/part8_15.PNG) <br>Сохранение дампов образов<br>


